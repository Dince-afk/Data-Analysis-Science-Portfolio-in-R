---
title: "Portfolio: Data Analysis in R"
output: rmarkdown::github_document
---

```{r include=FALSE}
library(tidyverse)
library(knitr)
library(kableExtra)
library(ggthemes)
library(dslabs)
```

```{r echo=FALSE}
knitr::opts_chunk$set(
  fig.path = "README_figs/README-"
)
```

Analysis is done with `tidyverse` and `ggplot2`.

# 1. Gapminder Dataset

## Exploration and analysis

What was the life expectancy in Germany for the last 60 years?

```{r}
gapminder %>% 
  filter(country == "Germany") %>% 
  ggplot() + 
  geom_line(aes(year,life_expectancy)) +
  scale_y_continuous(labels = scales::comma) + 
  xlab("Year") + ylab("Life Expectancy") + 
  ggtitle("Life Expectancy in Germany from 1960 to 2015")
```

What are the differences in infant mortality rates by continent?

```{r}
gapminder %>% 
  filter(year == 2014) %>% 
  ggplot() + geom_boxplot(aes(continent, infant_mortality, color = continent), show.legend = F) + 
  ggtitle("Infant Mortality Rates by Continents") + 
  xlab("Continents") + 
  ylab("Infant Mortality Rates")
  
```

What regions in gapminder are there actually?

```{r}
levels(gapminder$region)
```

Population bar graph of Europe by countries.

```{r}
gapminder %>% 
  filter(year == 2015 & continent == "Europe") %>% 
  ggplot(aes(y=reorder(country, population),x = population)) + 
  geom_bar(stat = "identity") + 
  scale_x_continuous(labels = scales::comma) + 
  ggtitle("Population of European Countries") + 
  xlab("Population") + 
  ylab("Country")
```

Pie chart of Europe's population

```{r}
gapminder %>% 
  filter(year == 2015 & continent == "Europe") %>% 
  ggplot(aes(y=reorder(country, population),x = population)) + 
  geom_bar(stat = "identity") + 
  scale_x_continuous(labels = scales::comma) + 
  coord_polar("y", start=0) +
  ggtitle("Population of European Countries") + 
  xlab("Population") + 
  ylab("Country")
```

What are the countries with the biggest life expectancy in Europe?

```{r}
gapminder %>% 
  filter(year == 2016 & continent == "Europe") %>% 
  slice_max(life_expectancy, n = 5)
```

Bar graph of life expectancy in Europe by countries.

```{r}
gapminder %>% 
  filter(year == 2016 & continent == "Europe") %>% 
  ggplot(aes(y = reorder(country, life_expectancy), x = life_expectancy)) +
  geom_bar(stat = "identity") + 
  coord_cartesian(xlim = c(70,85)) + 
  xlab("Life Expectancy") + ylab(NULL) + 
  labs(title = "Life Expectancy in European Countries (2016)", caption = "Gapminder data.")
```

The GDP of middle-eastern countries.

```{r}
gapminder %>% 
  filter(country %in% c("Israel", "Lebanon", "Egypt", "Saudi Arabia", "Bahrain", "West Bank and Gaza", "Yemen", "United Arab Emirate", "Iran", "Syria")) %>% 
  filter(year == 2009) %>% 
  ggplot(aes(gdp,country)) + 
  geom_bar(stat = "identity") + 
  ggtitle("Bar Graph of GDP in Middle-Eastern Countries") + 
  xlab("GDP") + 
  ylab("Country")
```

What was the correlation between fertility and life expectancy in 1962?

```{r}
gapminder %>% 
  filter(year == 1962) %>% 
  ggplot(aes(fertility, life_expectancy)) + 
  geom_point() + 
  ggtitle("Fertility and Life Expectancy in 1962") + 
  xlab("Fertility") + 
  ylab("Life Expectancy") + 
  theme_clean()
```

What was the correlation between fertility and life expectancy by continents in 1962?

```{r}
gapminder %>% 
  filter(year == 1962) %>% 
  ggplot(aes(fertility, life_expectancy, color = continent)) + 
  geom_point() + 
  ggtitle("Fertility and Life Expectancy in 1962") + 
  xlab("Fertility") + 
  ylab("Life Expectancy")
```

How was it in 2012 compared to 1962?

```{r}
gapminder %>% 
  filter(year %in% c(1962,2012)) %>% 
  ggplot(aes(fertility, life_expectancy, color = continent)) + 
  geom_point() + 
  facet_grid(.~year) + 
  ggtitle("Fertility and Life Expectancy in 1962 and 2012") + 
  xlab("Fertility") + 
  ylab("Life Expectancy")
```

Show me its development in detail over time

```{r}
gapminder %>% 
  filter(year %in% c(1962,1972,1982,1992,2002,2012)) %>% 
  ggplot(aes(fertility, life_expectancy, color = continent)) + 
  geom_point() + 
  facet_wrap(.~year) + 
  ggtitle("Fertility and Life Expectancy from 1962 to 2012") + 
  xlab("Fertility") + 
  ylab("Life Expectancy")
```

What is the fertility distribution in Europe like?

```{r}
gapminder %>% 
  filter(continent == "Europe" & year == 2015) %>% 
  ggplot(aes(fertility, fill = region)) + 
  geom_boxplot() + 
  coord_flip() +
  ggtitle("Fertility Rates in Europe by Regions in 2015") + 
  xlab("Fertility Rates")
```

What is the fertility distribution in Asia like?

```{r}
gapminder %>% 
  filter(continent == "Asia" & year == 2015) %>% 
  ggplot(aes(fertility, fill = region)) + 
  geom_boxplot() + 
  coord_flip() +
  ggtitle("Fertility Rates in Asia by Regions in 2015") + 
  xlab("Fertility Rates")
```

What is the fertility distribution like by continents?

```{r}
gapminder %>% 
  filter(year == 2015) %>%  
  ggplot(aes(fertility,continent, fill = continent)) + ggridges::geom_density_ridges(show.legend = F) + 
  ggtitle("Fertility Rates by Continents in 2015") + 
  xlab("Fertility Rates") + 
  ylab("Continents")
```

Density rigdes on other variable distributions

```{r}
gapminder %>% 
  filter(year == 2015) %>% 
  ggplot(aes(life_expectancy,continent, fill = continent)) + 
  ggridges::geom_density_ridges(show.legend = F) + 
  ggtitle("Life Expectancy by Continents in 2015") + 
  xlab("Life Expectancy") + 
  ylab("Continents")
```

How has the life expectancy in countries by continents changed between the years 1962 and 2012?

```{r}
gapminder %>% 
  filter(year %in% c(1962,2012)) %>% 
  mutate(year = factor(year, levels = c(1962,2012))) %>% 
  ggplot(aes(continent,life_expectancy, fill = year)) + 
  geom_boxplot() + 
  xlab("Continent") + ylab("Life Expectancy") + 
  labs(title = "Life expectancy between continents in 1962 and 2012")
```

# 2. European Social Survey Dataset

## Require data

```{r cache=TRUE}
library(essurvey)

# Set email. Needed for authentication
set_email("dino.c@me.com")

# # Show which countries are available
show_countries()

# Download data
ess_9 <- import_rounds(9)
```

## Exploration and analysis

Skim to get an overview of the variables.

```{r}
# skimr::skim(ess_9)
```

Glimpse to get a peak at the first values.

```{r}
# glimpse(ess_9)
head(ess_9)
```

## Interesting variables

-   [wltdffr: Differences in wealth in country, how fair](http://nesstar.ess.nsd.uib.no/webview/index.jsp?v=2&submode=variable&study=http%3A%2F%2F129.177.90.83%3A-1%2Fobj%2FfStudy%2FESS9e03.1&gs=undefined&variable=http%3A%2F%2F129.177.90.83%3A80%2Fobj%2FfVariable%2FESS9e03.1_V518&mode=documentation&top=yes)

-   [poltran: Decisions in country politics are transparent](http://nesstar.ess.nsd.uib.no/webview/index.jsp?v=2&submode=variable&study=http%3A%2F%2F129.177.90.83%3A-1%2Fobj%2FfStudy%2FESS9e03.1&gs=undefined&variable=http%3A%2F%2F129.177.90.83%3A80%2Fobj%2FfVariable%2FESS9e03.1_V518&mode=documentation&top=yes)

-   [grspfr: Would you say your gross pay is unfairly low, fair, or unfairly high](http://nesstar.ess.nsd.uib.no/webview/index.jsp?v=2&submode=variable&study=http%3A%2F%2F129.177.90.83%3A-1%2Fobj%2FfStudy%2FESS9e03.1&gs=undefined&variable=http%3A%2F%2F129.177.90.83%3A80%2Fobj%2FfVariable%2FESS9e03.1_V518&mode=documentation&top=yes)

-   [imprich: Important to be rich, have money and expensive things](http://nesstar.ess.nsd.uib.no/webview/index.jsp?v=2&submode=variable&study=http%3A%2F%2F129.177.90.83%3A-1%2Fobj%2FfStudy%2FESS9e03.1&gs=undefined&variable=http%3A%2F%2F129.177.90.83%3A80%2Fobj%2FfVariable%2FESS9e03.1_V518&mode=documentation&top=yes)

-   [ipeqopt: Important that people are treated equally and have equal opportunities](http://nesstar.ess.nsd.uib.no/webview/index.jsp?v=2&submode=variable&study=http%3A%2F%2F129.177.90.83%3A-1%2Fobj%2FfStudy%2FESS9e03.1&gs=undefined&variable=http%3A%2F%2F129.177.90.83%3A80%2Fobj%2FfVariable%2FESS9e03.1_V518&mode=documentation&top=yes)

-   [ipstrgv: Important that government is strong and ensures safety](http://nesstar.ess.nsd.uib.no/webview/index.jsp?v=2&submode=variable&study=http%3A%2F%2F129.177.90.83%3A-1%2Fobj%2FfStudy%2FESS9e03.1&gs=undefined&variable=http%3A%2F%2F129.177.90.83%3A80%2Fobj%2FfVariable%2FESS9e03.1_V518&mode=documentation&top=yes)

How many subjects were questioned per country?

```{r}
ess_9 %>% 
  group_by(cntry) %>% 
  count(sort = T) %>% 
  ggplot() + 
  aes(n, reorder(cntry, n), label = n) + 
  geom_bar(stat = "identity", fill = "steelblue") +
  ggtitle("Subjects per Country")
```

What are the opinions on differences in wealth?

```{r}
ess_9 %>% 
  count(wltdffr) %>% 
  ggplot() + 
  aes(n, wltdffr) + 
  geom_bar(stat = "identity") + 
  ggtitle("Differences in wealth in country, how fair") + 
  ylab("Answers")
```

Here are the results for Germany.

```{r}
ess_9 %>% 
  filter(cntry == "DE") %>% 
  count(wltdffr) %>% 
  ggplot() + 
  aes(n, wltdffr) + 
  geom_bar(stat = "identity") + 
  ggtitle("Differences in wealth in Germany, how fair") + 
  ylab("Answers")
```

What are the options and how many are there?

```{r}
ess_9 %>% 
  distinct(wltdffr)

ess_9 %>% 
  count(wltdffr)
```

Recode values to only have four left at the end, too large unfair or fair and too small unfair and NAs.

```{r}
ess_9 = ess_9 %>% 
  mutate(new_wltdffr = fct_collapse(wltdffr, 
             Too_Large = c("Large, extremely unfair", "Large, very unfair", "Large, somewhat unfair","Large, slightly unfair"), 
             Fair = "Fair", 
             Too_Small = c("Small, extremely unfair", "Small, very unfair", "Small, somewhat unfair","Small, slightly unfair"))) %>% 
  mutate(new_wltdffr = factor(new_wltdffr, levels = c("Too_Large", "Fair", "Too_Small")))
```

Create a count and percentage table.

```{r}
d = ess_9 %>% 
  group_by(new_wltdffr) %>% 
  summarise(count = n()) %>% 
  mutate(perc = count/sum(count))
```

Plot a bar graph.

```{r}
d %>% 
  ggplot(aes(new_wltdffr, perc, label = round(perc, 2), fill = new_wltdffr)) + 
  geom_bar(stat = "identity") + 
  geom_label(aes(fill = NA), fill = "white") + 
  theme(legend.position = "none") + 
  xlab("Differences in Wealth, Opinon") + ylab("Percentage") + 
  ggtitle("Opinion on Differences in Wealth 2018")
```

# 3. WDI Dataset

## Require data

```{r}
library(WDI)
```

Search for topics in datasets.

```{r cache=TRUE}
head(WDIsearch("co2"), 10)

WDIsearch('gdp.*capita.*constant')

# Download
dat = WDI(
  country = "all", 
  indicator = c(
  population =  "SP.POP.TOTL", 
  gdp = "NY.GDP.MKTP.CD",
  inc_sha_10 = "SI.DST.10TH.10"),
  start = 1960, end = 2018)
```

## Exploration and analysis

What was the population development like in these specific countries?

```{r}
dat %>% 
  filter(country %in% c("Germany","France","United States", "Bosnia and Herzegovina","United Kingdom","China")) %>% 
  ggplot(aes(year,population, color = country)) + 
  geom_line() + 
  scale_y_log10(labels = scales::comma) + 
  ylab("Population (log10)") + xlab("Year") + 
  labs(title = "Random Countries Population", color = "Country")
```

What was the population development like in the former Yugoslav Republics?

```{r}
dat %>% 
  filter(country %in% c("Bosnia and Herzegovina","Croatia","Serbia","Montenegro","Slovenia","North Macedonia","Kosovo")) %>% 
  ggplot(aes(year,population, color = reorder(country, desc(population)))) + 
  geom_line() + 
  scale_x_continuous(breaks = seq(1960,2020,5)) + 
  scale_y_continuous(labels = scales::comma) + 
  labs(title = "Population of Former Yugoslav Republics", subtitle = "Population trends and shifts since the 1990s", col = "Countries") + 
  xlab("Year") + ylab("Population")
```

What was the development of GDP in the former Yugoslav Republics?

```{r}
dat %>% 
  filter(country %in% c("Bosnia and Herzegovina","Croatia","Serbia","Montenegro","Slovenia","North Macedonia","Kosovo")) %>% 
  filter(between(year, 1995, 2020)) %>% 
  ggplot(aes(year,gdp, color = reorder(country, desc(gdp)))) + 
  geom_line() + 
  scale_x_continuous(breaks = seq(1960,2020,2)) + 
  scale_y_continuous(labels = scales::dollar) +
  labs(title = "GDP of Former Yugoslav Republics", subtitle = "Economic trends and shifts since the 1990s" , col = "Countries") +
  xlab("Year") + ylab("GDP current US$")
```

# Frequent Data Analysis Problems + Solutions

## First exploration of new dataset

The `skim()`shows how many missing and unique values each variable has. It uses appropriate measures to describe each variable based on its type: character, numeric or list.

```{r}
skimr::skim(starwars)
```

The glimpse function, on the other hand, gives us a good peak at the first raw values each variable has.

```{r}
glimpse(starwars)
```

## A Count and prop table

**First way with `forcats::fct_count()`** Calculates a count and prop table.

```{r}
starwars$sex %>%
 factor() %>% 
  fct_count(sort = T, prop = T)
```

**Second way with `deplyr::count()`** Simply mutate a frequency and percentage column on a counted table.

```{r}
starwars %>% 
 count(sex) %>% 
  mutate(freq = n / sum(n)) %>% 
  mutate(perc = freq * 100)
```

## Bar graph with count data

Here is a situation where we calculated a count table for hair color - we summarized all values. If we then want to plot a bar graph based on that count table we run into problems, because ggplot2 is expecting a non-summarized or normal data frame.

```{r}
hair_color_table = starwars %>% 
  mutate(hair_color = fct_lump_min(hair_color, 2)) %>% 
  group_by(hair_color) %>% 
  summarise(n = n())
hair_color_table
```

To tell the function that we have already summarized data, we add the argument `stat = "identity"` to the `geom_bar()` function.

```{r}
hair_color_table %>% 
  ggplot(aes(x = reorder(hair_color, n), y = n, fill = hair_color)) + 
  geom_bar(stat = "identity") + 
  theme(legend.position = "none")
```

## Bar graph with percentage labels

First we create a table with counts and percentages:

```{r}
d = starwars %>% 
  group_by(gender) %>% 
  summarise(count = n()) %>% 
  mutate(percentage = count/sum(count))
d
```

Then we plot a graph with bar and with percentage labels.

```{r}
d %>% 
  ggplot(aes(gender, percentage, label = round(percentage, 2), fill = gender)) + 
  geom_bar(stat = "identity") + 
  geom_label(aes(fill = NA), fill = "white") + 
  theme(legend.position = "none")
```

## Collapse factors to „Other"

This syntax mutates the categorical variable homeworld into eight of its most frequent values. The other values are being collapsed into the categorical value „other".

```{r}
starwars %>% 
  mutate(homeworld = fct_lump_n(homeworld, n = 8)) %>% 
  group_by(homeworld) %>% 
  summarise(mean(height, na.rm =T), mean(mass, na.rm = T), n())
```

## Filter for specific values

We can easily filter out cases with certain column values, like for example the states of Hawai and Alaska. We use `filter()`, the operator `!` and `%in%`.

```{r}
starwars %>% 
  filter(!homeworld%in%c("Tatooine","Naboo")) %>% 
  select(name, homeworld)
```

## Change bar colors in barplot

You can manually pick the colors with `fill` and a vector containing the color values. Either in String, written out.

```{r}
starwars %>% 
  mutate(sex = fct_infreq(sex)) %>% 
  ggplot(aes(sex)) + 
  geom_bar(fill = c("red","blue","green","black","grey")) 
```

Or with RGB Color Codes.

```{r}
starwars %>% 
    mutate(sex = fct_infreq(sex)) %>%
    ggplot(aes(sex)) +
    geom_bar(fill = c("#003f5c","#58508d","#bc5090","#ff6361","#ffa600")) 
```

## Hide aes(color) mapping legend

Here is an example where we want the bar colored based on the variable itself, but without the mapping legend.

```{r}
starwars %>% 
  mutate(sex = fct_infreq(sex)) %>% 
  ggplot(aes(sex, fill = sex)) + 
  geom_bar()
```

Hide the geom_bar legend.

```{r}
starwars %>% 
  mutate(sex = fct_infreq(sex)) %>% 
  ggplot(aes(sex, fill = sex)) + 
  geom_bar(show.legend = F)
```

Remove just the legend title:

```{r}
starwars %>% 
  mutate(sex = fct_infreq(sex)) %>% 
  ggplot(aes(sex, fill = sex)) + 
  geom_bar() +
  theme(legend.title = element_blank())
```

Hide all legends created:

```{r}
starwars %>% 
  mutate(sex = fct_infreq(sex)) %>% 
  ggplot(aes(sex, fill = sex)) + 
  geom_bar() +
  theme(legend.position = "none")
```

## Re-code values of categorical variables

**First way** We can use `fct_collapse()`to create a new column with the new recoded values in it.

```{r eval=FALSE, include=FALSE}
ess_9 = ess_9 %>% 
  mutate(new_wltdffr = fct_collapse(wltdffr, 
             Too_Large = c("Large, extremely unfair", "Large, very unfair", "Large, somewhat unfair","Large, slightly unfair"), 
             Fair = "Fair", 
             Too_Small = c("Small, extremely unfair", "Small, very unfair", "Small, somewhat unfair","Small, slightly unfair"))) %>% 
  mutate(new_wltdffr = factor(new_wltdffr, levels = c("Too_Large", "Fair", "Too_Small")))
```

**Second way** By using `mutate`, to create a new column with our own values and `case_when`, to run through our observations looking for defined cases, together with "variable" `%in%`, we can create our own groups.

```{r}
gapminder %>% 
 mutate(group = case_when(
    region %in% c("Western Europe", "Northern Europe","Southern Europe","Northern America", "Australia and New Zealand") ~ "West", # If region is one of values -> assign it "West" in new group column.
    region %in% c("Eastern Asia", "South-Eastern Asia") ~ "East Asia",
    region %in% c("Caribbean", "Central America", "South America") ~ "Latin America",
    continent == "Africa" & 
      region != "Northern Africa" ~ "Sub-Saharan",
    TRUE ~ "Others")) %>%  # If nothing above applies -> assign it "Others" in group column
  head(10)

```

We turn this `group` variable into a factor to control the order of the levels:

```{r eval=FALSE, include=FALSE}
gapminder %>% 
  mutate(group = factor(group, levels = c("Others", "Latin America", "East Asia", "Sub-Saharan","West")))
```

## Order color legend

Order color legend by a variable's values.

```{r eval=FALSE, include=FALSE}
data %>% 
    ggplot(aes(year,population, color = reorder(country, desc(population)))) + # "Reorder countries by descending order of population"
    geom_line() 
```

## Show unique values

Display all unique values of variable.

```{r}
distinct(starwars, species) # dplyr function
```

**Note**: `distinct(dat$countries)` doesn't work.

## Slice rows by maximum or minimum values

**Note:** parameter `n` must be explicitly written, otherwise it throws an error.

```{r}
starwars %>% 
  slice_max(height, n = 5)
```

Show me 5% of the lowest height rows.

```{r}
starwars %>% 
  slice_min(height, prop = 0.05)
```

## Show Number of `NA`s

For a quick check of how many missing values there are in a single column:

```{r}
sum(is.na(starwars$height))
```

And how many are not `NA`s.

```{r}
sum(!is.na(starwars$height))
```

For a more detailed overview of the whole dataset use `skim()`. It shows a very useful `complete_rate` which tells us how much of the column is disturbed by missing values.

```{r}
skimr::skim(starwars)
```

## Drop rows with missing values

Drop rows that have `NA`values in a specific column, here in `height`.

```{r}
starwars %>% 
  drop_na(height)
```

Drop all rows that contain `NA` in any column.

```{r}
starwars %>% 
  drop_na()
```

Filter out any NA containing rows.

```{r}
starwars %>% 
 na.exclude()
```

## Replace `NA`s

Replace 0 with value you want as a replacement.

```{r}
data(na_example)
sum(is.na(na_example))

no_nas <- ifelse(is.na(na_example), 0, na_example) # "if is NA is true, change value to 0, else keep the value (i.e. na_example)"

sum(is.na(no_nas))
```

## The factor variable trap

The FVT is about what happens when you try to return factorized vectors into numeric values. Let's look at this with this code.

```{r}
z <-factor(c("12", "13", "14", "15", "12")) # We create an object by directly factorizing a vector. 
z

y <- as.numeric(z) # Now we want to convert them into numeric values. 
y # What?
```

This happened, because we picked up the on the factorization result. `factor()` assigns every element, based on its value, an integer number.

```{r}
typeof(z) # 1=12, 13=2, 14=3, 15=4, 12=1
```

To fix this problem, first convert the object back to character and then to numeric.

```{r}
y <- as.numeric(as.character(z))
y
```
