---
title: "Portfolio: R and Data Analysis"
output: rmarkdown::github_document
---

```{r include=FALSE}
library(tidyverse)
library(knitr)
library(kableExtra)
library(ggthemes)
library(dslabs)
```

```{r echo=FALSE}
knitr::opts_chunk$set(
  fig.path = "README_figs/README-"
)
```

# Gapminder

## Analysis

What was the life expectancy in Germany for the last 60 years?

```{r}
gapminder %>% 
  filter(country == "Germany") %>% 
  ggplot() + 
  geom_line(aes(year,life_expectancy)) +
  scale_y_continuous(labels = scales::comma) + 
  xlab("Year") + ylab("Life Expectancy") + 
  ggtitle("Line Graph of Life Expectancy in Germany")
```

What are the differences in infant mortality rates by continent?

```{r}
gapminder %>% 
  filter(year == 2014) %>% 
  ggplot() + geom_boxplot(aes(continent, infant_mortality, color = continent), show.legend = F) + 
  ggtitle("Infant Mortality Rates by Continents") + 
  xlab("Continents") + 
  ylab("Infant Mortality Rates")
  
```

What regions in gapminder are there actually?

```{r}
levels(gapminder$region)
```

Population bar graph of Europe by countries.

```{r}
gapminder %>% 
  filter(year == 2015 & continent == "Europe") %>% 
  ggplot(aes(y=reorder(country, population),x = population)) + 
  geom_bar(stat = "identity") + 
  scale_x_continuous(labels = scales::comma) + 
  ggtitle("Bar Graph of European Countries") + 
  xlab("Population") + 
  ylab("Country")
```

Pie chart of Europe's population

```{r}
gapminder %>% 
  filter(year == 2015 & continent == "Europe") %>% 
  ggplot(aes(y=reorder(country, population),x = population)) + 
  geom_bar(stat = "identity") + 
  scale_x_continuous(labels = scales::comma) + 
  coord_polar("y", start=0) +
  ggtitle("Bar Graph of European Countries") + 
  xlab("Population") + 
  ylab("Country")
```

What are the countries with the biggest life expectancy in Europe?

```{r}
gapminder %>% 
  filter(year == 2016 & continent == "Europe") %>% 
  slice_max(life_expectancy, n = 5)
```

Bar graph of life expectancy in Europe by countries.

```{r}
gapminder %>% 
  filter(year == 2016 & continent == "Europe") %>% 
  ggplot(aes(y = reorder(country, life_expectancy), x = life_expectancy)) +
  geom_bar(stat = "identity") + 
  coord_cartesian(xlim = c(70,85)) + 
  xlab("Life Expectancy") + ylab(NULL) + 
  labs(title = "Life Expectancy in European Countries (2016)", caption = "Gapminder data.")
```

The GDP of middle-eastern countries.

```{r}
gapminder %>% 
  filter(country %in% c("Israel", "Lebanon", "Egypt", "Saudi Arabia", "Bahrain", "West Bank and Gaza", "Yemen", "United Arab Emirate", "Iran", "Syria")) %>% 
  filter(year == 2009) %>% 
  ggplot(aes(gdp,country)) + 
  geom_bar(stat = "identity") + 
  ggtitle("Bar Graph of GDP in Middle-Eastern Countries") + 
  xlab("GDP") + 
  ylab("Country")
```

What was the correlation between fertility and life expectancy in 1962?

```{r}
gapminder %>% 
  filter(year == 1962) %>% 
  ggplot(aes(fertility, life_expectancy)) + 
  geom_point() + 
  ggtitle("Fertility and Life Expectancy in 1962") + 
  xlab("Fertility") + 
  ylab("Life Expectancy") + 
  theme_clean()
```

What was the correlation between fertility and life expectancy by continents in 1962?

```{r}
gapminder %>% 
  filter(year == 1962) %>% 
  ggplot(aes(fertility, life_expectancy, color = continent)) + 
  geom_point() + 
  ggtitle("Fertility and Life Expectancy in 1962") + 
  xlab("Fertility") + 
  ylab("Life Expectancy")
```

How was it in 2012 compared to 1962?

```{r}
gapminder %>% 
  filter(year %in% c(1962,2012)) %>% 
  ggplot(aes(fertility, life_expectancy, color = continent)) + 
  geom_point() + 
  facet_grid(.~year) + 
  ggtitle("Fertility and Life Expectancy in 1962 and 2012") + 
  xlab("Fertility") + 
  ylab("Life Expectancy")
```

Show me its development in detail over time

```{r}
gapminder %>% 
  filter(year %in% c(1962,1972,1982,1992,2002,2012)) %>% 
  ggplot(aes(fertility, life_expectancy, color = continent)) + 
  geom_point() + 
  facet_wrap(.~year) + 
  ggtitle("Fertility and Life Expectancy from 1962 to 2012") + 
  xlab("Fertility") + 
  ylab("Life Expectancy")
```

What is the fertility distribution in Europe like?

```{r}
gapminder %>% 
  filter(continent == "Europe" & year == 2015) %>% 
  ggplot(aes(fertility, fill = region)) + 
  geom_boxplot() + 
  coord_flip() +
  ggtitle("Fertility Rates in Europe by Regions in 2015") + 
  xlab("Fertility Rates")
```

What is the fertility distribution in Asia like?

```{r}
gapminder %>% 
  filter(continent == "Asia" & year == 2015) %>% 
  ggplot(aes(fertility, fill = region)) + 
  geom_boxplot() + 
  coord_flip() +
  ggtitle("Fertility Rates in Asia by Regions in 2015") + 
  xlab("Fertility Rates")
```

What is the fertility distribution like by continents?

```{r}
gapminder %>% 
  filter(year == 2015) %>%  
  ggplot(aes(fertility,continent, fill = continent)) + ggridges::geom_density_ridges(show.legend = F) + 
  ggtitle("Fertility Rates by Continents in 2015") + 
  xlab("Fertility Rates") + 
  ylab("Continents")
```

Density rigdes on other variable distributions

```{r}
gapminder %>% 
  filter(year == 2015) %>% 
  ggplot(aes(life_expectancy,continent, fill = continent)) + 
  ggridges::geom_density_ridges(show.legend = F) + 
  ggtitle("Life Expectancy by Continents in 2015") + 
  xlab("Life Expectancy") + 
  ylab("Continents")
```

How has the life expectancy in countries by continents changed between the years 1962 and 2012?

```{r}
gapminder %>% 
  filter(year %in% c(1962,2012)) %>% 
  mutate(year = factor(year, levels = c(1962,2012))) %>% 
  ggplot(aes(continent,life_expectancy, fill = year)) + 
  geom_boxplot() + 
  xlab("Continent") + ylab("Life Expectancy") + 
  labs(title = "Life expectancy between continents in 1962 and 2012")
```

# European Social Survey

## Data

```{r cache=TRUE}
library(essurvey)

# Set email. Needed for authentication
set_email("dino.c@me.com")

# # Show which countries are available
show_countries()

# Download data
ess_9 <- import_rounds(9)
```

## Preparation?

```{r}
# glimpse(ess_9)
# summary(ess_9)
att_data = attributes(ess_9)
# sk = skim(ess_9)
# 
# DataExplorer::create_report(ess_9)
# 
# helpful_list = list(att_data$var.labels,)
# 
#   attributes(ess_9)["var.labels","val.labels"]
# val_labels = attributes(ess_9)["label.table"]
# str(ess_9)
# ess_9$nwspol
# 
# ess_9 %>%
#   group_by(cntry) %>%
#   summarise(mean_h = mean(nwspol, na.rm = T)) %>%
#   ggplot() + aes(mean_h, reorder(cntry, mean_h)) + geom_bar(stat = "identity")
# 
# attr(ess_9)
# 
# # sjlabelled package
# rm(all_labels_1)
# all_labels_1 = get_labels(ess_9, attr.only = T)
# names(all_labels_1) = all_var_labels
# 
# # labelled package way
# var_list = val_labels(ess_9)
# all_var_labels = unlist(var_label(ess_9))
# names(all_labels_2) = all_var_labels
```

## Exploration

Skim to get an overview of the variables.

```{r}
# skimr::skim(ess_9)
```

Glimpse to get a peak at the first values.

```{r}
# glimpse(ess_9)
head(ess_9)
```

Show the variable labels stored in attributes.

```{r}
# attributes(ess_9)["var.labels"]
```

## Variables

-   [wltdffr: Differences in wealth in country, how fair](http://nesstar.ess.nsd.uib.no/webview/index.jsp?v=2&submode=variable&study=http%3A%2F%2F129.177.90.83%3A-1%2Fobj%2FfStudy%2FESS9e03.1&gs=undefined&variable=http%3A%2F%2F129.177.90.83%3A80%2Fobj%2FfVariable%2FESS9e03.1_V518&mode=documentation&top=yes)

-   [poltran: Decisions in country politics are transparent](http://nesstar.ess.nsd.uib.no/webview/index.jsp?v=2&submode=variable&study=http%3A%2F%2F129.177.90.83%3A-1%2Fobj%2FfStudy%2FESS9e03.1&gs=undefined&variable=http%3A%2F%2F129.177.90.83%3A80%2Fobj%2FfVariable%2FESS9e03.1_V518&mode=documentation&top=yes)

-   [grspfr: Would you say your gross pay is unfairly low, fair, or unfairly high](http://nesstar.ess.nsd.uib.no/webview/index.jsp?v=2&submode=variable&study=http%3A%2F%2F129.177.90.83%3A-1%2Fobj%2FfStudy%2FESS9e03.1&gs=undefined&variable=http%3A%2F%2F129.177.90.83%3A80%2Fobj%2FfVariable%2FESS9e03.1_V518&mode=documentation&top=yes)

-   [imprich: Important to be rich, have money and expensive things](http://nesstar.ess.nsd.uib.no/webview/index.jsp?v=2&submode=variable&study=http%3A%2F%2F129.177.90.83%3A-1%2Fobj%2FfStudy%2FESS9e03.1&gs=undefined&variable=http%3A%2F%2F129.177.90.83%3A80%2Fobj%2FfVariable%2FESS9e03.1_V518&mode=documentation&top=yes)

-   [ipeqopt: Important that people are treated equally and have equal opportunities](http://nesstar.ess.nsd.uib.no/webview/index.jsp?v=2&submode=variable&study=http%3A%2F%2F129.177.90.83%3A-1%2Fobj%2FfStudy%2FESS9e03.1&gs=undefined&variable=http%3A%2F%2F129.177.90.83%3A80%2Fobj%2FfVariable%2FESS9e03.1_V518&mode=documentation&top=yes)

-   [ipstrgv: Important that government is strong and ensures safety](http://nesstar.ess.nsd.uib.no/webview/index.jsp?v=2&submode=variable&study=http%3A%2F%2F129.177.90.83%3A-1%2Fobj%2FfStudy%2FESS9e03.1&gs=undefined&variable=http%3A%2F%2F129.177.90.83%3A80%2Fobj%2FfVariable%2FESS9e03.1_V518&mode=documentation&top=yes)

How many subjects were questioned per country?

```{r}
ess_9 %>% 
  group_by(cntry) %>% 
  count(sort = T) %>% 
  ggplot() + 
  aes(n, reorder(cntry, n), label = n) + 
  geom_bar(stat = "identity", fill = "steelblue") +
  geom_label() + 
  ggtitle("Subjects per Country")
```

How much time do subjects spent watching the news per country?

```{r}
ess_9 %>% 
  group_by(cntry) %>% 
  summarise(mean_h = mean(nwspol, na.rm = T)) %>% 
  ggplot() + 
  aes(mean_h, reorder(cntry, mean_h)) + 
  geom_bar(stat = "identity")
```

A bar graph displaying opinions on differences in wealth.

```{r}
ess_9 %>% 
  count(wltdffr) %>% 
  ggplot() + 
  aes(n, wltdffr) + 
  geom_bar(stat = "identity") + 
  ggtitle("Differences in wealth in country, how fair") + 
  ylab("Answers")
```

Here are the results for Germany.

```{r}
ess_9 %>% 
  filter(cntry == "DE") %>% 
  count(wltdffr) %>% 
  ggplot() + 
  aes(n, wltdffr) + 
  geom_bar(stat = "identity") + 
  ggtitle("Differences in wealth in Germany, how fair") + 
  ylab("Answers")
```

What are the options and how many are there?

```{r}
ess_9 %>% 
  distinct(wltdffr)

ess_9 %>% 
  count(wltdffr)
```

Recode values to only have four left at the end, too large unfair or fair and too small unfair and NAs.

```{r}
ess_9 = ess_9 %>% 
  mutate(new_wltdffr = fct_collapse(wltdffr, 
             Too_Large = c("Large, extremely unfair", "Large, very unfair", "Large, somewhat unfair","Large, slightly unfair"), 
             Fair = "Fair", 
             Too_Small = c("Small, extremely unfair", "Small, very unfair", "Small, somewhat unfair","Small, slightly unfair"))) %>% 
  mutate(new_wltdffr = factor(new_wltdffr, levels = c("Too_Large", "Fair", "Too_Small")))
```

Create a count and percentage table.

```{r}
d = ess_9 %>% 
  group_by(new_wltdffr) %>% 
  summarise(count = n()) %>% 
  mutate(perc = count/sum(count))
```

Plot a bar graph.

```{r}
d %>% 
  ggplot(aes(new_wltdffr, perc, label = round(perc, 2), fill = new_wltdffr)) + 
  geom_bar(stat = "identity") + 
  geom_label(aes(fill = NA), fill = "white") + 
  theme(legend.position = "none") + 
  xlab("Differences in Wealth, Opinon") + ylab("Percentage") + 
  ggtitle("Opinion on Differences in Wealth 2018")
```

# WDI

## Data

```{r}
library(WDI)
```

```{r cache=TRUE}
# Search for topics in datasets
head(WDIsearch("co2"), 10)

WDIsearch('gdp.*capita.*constant')

# Download
dat = WDI(
  country = "all", 
  indicator = c(
  population =  "SP.POP.TOTL", 
  gdp = "NY.GDP.MKTP.CD",
  inc_sha_10 = "SI.DST.10TH.10"),
  start = 1960, end = 2018)
```

## Exploration

```{r}
# Population Developments
summary(dat)
n_distinct(dat$country)
distinct(dat, country)
```

## Analysis

Random countries population.

```{r}
dat %>% 
  filter(country %in% c("Germany","France","United States", "Bosnia and Herzegovina","United Kingdom","China")) %>% 
  ggplot(aes(year,population, color = country)) + 
  geom_line() + 
  scale_y_log10(labels = scales::comma) + 
  ylab("Population (log10)") + xlab("Year") + 
  labs(title = "Random Countries Population", color = "Country")
```

Bosnia's population development.

```{r}
dat %>% 
  filter(country=="Bosnia and Herzegovina") %>% 
  ggplot(aes(year,population)) + geom_bar(stat = "identity") + 
  scale_x_continuous(breaks = seq(1960,2020,5)) + 
  scale_y_continuous(labels = scales::comma) + 
  labs(title = "Population of Bosnia and Hercegovina") + 
  xlab("Year") + ylab("Population")
```

Balkan population development.

```{r}
dat %>% 
  filter(country %in% c("Bosnia and Herzegovina","Croatia","Serbia","Montenegro","Slovenia","North Macedonia","Kosovo")) %>% 
  ggplot(aes(year,population, color = reorder(country, desc(population)))) + 
  geom_line() + 
  scale_x_continuous(breaks = seq(1960,2020,5)) + 
  scale_y_continuous(labels = scales::comma) + 
  labs(title = "Population of Former Yugoslav Republics", subtitle = "Population trends and shifts since the 1990s", col = "Countries") + 
  xlab("Year") + ylab("Population")
```

Balkan GDP development.

```{r}
dat %>% 
  filter(country %in% c("Bosnia and Herzegovina","Croatia","Serbia","Montenegro","Slovenia","North Macedonia","Kosovo")) %>% 
  filter(between(year, 1995, 2020)) %>% 
  ggplot(aes(year,gdp, color = reorder(country, desc(gdp)))) + 
  geom_line() + 
  scale_x_continuous(breaks = seq(1960,2020,2)) + 
  scale_y_continuous(labels = scales::dollar) +
  labs(title = "GDP of Former Yugoslav Republics", subtitle = "Economic trends and shifts since the 1990s" , col = "Countries") +
  xlab("Year") + ylab("GDP current US$")
```

Income share by richest 10% in Germany and the United States.

```{r}
dat %>% 
  filter(country %in% c("Germany","United States")) %>% 
  filter(between(year, 1990, 2020)) %>% 
  ggplot(aes(year,inc_sha_10, color = country)) + geom_line()
```

# Star Wars

## Exploration

```{r}
skimr::skim(starwars)
```

## Analysis

Count and proportion table for gender distribution.

```{r}
starwars$gender %>% 
  fct_count(sort = T, prop = T)

starwars %>% 
  count(gender, sex, sort = T)
```

# Economics

## Analysis

Unemployment over time.

```{r}
economics %>% 
  ggplot() + geom_line(aes(date, unemploy))

```

# Heights

## Analysis

```{r}
# heights[male,] %>%
#   ggplot(aes(height)) +
#   geom_density(color = "red") +
#   geom_density(aes(norm_dist), color = "blue") +
#   geom_label(aes(x = 67, y = 0.09, label = "Heights Distribution"), color = "red")
```

```{r}
# ## Density vs Normal Distribution 
# male = heights$sex == "Male"
# 
# m = mean(heights$height[male])
# s = sd(heights$height[male])
# 
# norm_dist = rnorm(812, mean = m, sd = s)
```

Histogram of female height distribution.

```{r}
heights %>% 
  filter(sex == "Female") %>% 
  ggplot(aes(height)) + 
  geom_histogram(color = "black", fill = "red") + 
  xlab("Female height in meters") + ggtitle("Histogram")
```

Boxplot of heights by sex.

```{r}
heights %>% 
  ggplot(aes(sex, height)) + 
  geom_boxplot(outlier.shape = NA, fill = c("red", "blue")) + 
  geom_jitter(alpha = 0.5, size = 1)
```

QQPlots.

```{r}
heights %>% 
  ggplot(aes(sample = height)) + geom_qq() + stat_qq() + stat_qq_line()

heights %>% 
  filter(sex=="Male") %>%
  ggplot(aes(sample = scale(height))) + 
  geom_qq() +
  geom_abline()
```

# 
